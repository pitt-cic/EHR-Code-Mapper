<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EHR Code Mapping Validator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header h1 { font-size: 24px; margin-bottom: 10px; }
        .progress { 
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-bar {
            background: #4CAF50;
            height: 100%;
            transition: width 0.3s;
        }
        .card {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .prop-code {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .prop-code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .prop-code h2 { font-size: 20px; color: #333; margin: 0; }
        .prop-code .context { color: #333; font-size: 15px; line-height: 1.6; }
        .prop-code .type-badge {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .options { display: flex; flex-direction: column; gap: 15px; }
        .option {
            border: 2px solid #ddd;
            padding: 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option:hover { border-color: #4CAF50; background: #f9fff9; }
        .option.selected { border-color: #4CAF50; background: #e8f5e9; }
        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .option-title { font-weight: 600; font-size: 16px; }
        .option-rank { 
            background: #2196F3;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
        }
        .option-rank.unavailable {
            background: #999;
        }
        .option-code { color: #666; font-size: 14px; margin-bottom: 8px; }
        .option:nth-child(1) { background: #f0f9ff; }
        .option:nth-child(2) { background: #f9f0ff; }
        .option:nth-child(3) { background: #fff9f0; }
        .option-reasoning { color: #444; font-size: 14px; line-height: 1.5; }
        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        .btn-primary:hover { background: #45a049; }
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        .btn-secondary:hover { background: #e0e0e0; }
        .complete {
            text-align: center;
            padding: 40px;
        }
        .complete h2 { color: #4CAF50; margin-bottom: 20px; }
        .hidden { display: none; }
        #fileInput { margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>EHR Code Mapping Validator</h1>
            <input type="file" id="fileInput" accept=".csv">
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <p id="progressText" style="margin-top: 10px; color: #666;"></p>
        </div>

        <div id="validationCard" class="card hidden">
            <div class="prop-code">
                <div class="prop-code-header">
                    <h2 id="propDisplay"></h2>
                    <span class="type-badge" id="typeBadge"></span>
                </div>
                <p class="context" id="propContext"></p>
            </div>

            <div class="options" id="optionsContainer"></div>

            <div class="buttons">
                <button class="btn-secondary" id="prevBtn" onclick="prevMapping()">Previous</button>
                <button class="btn-primary" id="nextBtn" onclick="nextMapping()" disabled>Next</button>
            </div>
        </div>

        <div id="completeCard" class="card complete hidden">
            <h2>âœ“ Validation Complete!</h2>
            <p style="margin-bottom: 20px;">All mappings have been validated.</p>
            <button class="btn-primary" onclick="downloadCSV()">Download validated_mappings.csv</button>
        </div>
    </div>

    <script>
        let mappings = [];
        let currentIndex = 0;
        let validatedMappings = [];

        document.getElementById('fileInput').addEventListener('change', handleFileSelect);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                parseCSV(text);
            };
            reader.readAsText(file);
        }

        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',');
            
            mappings = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => {
                    row[header.trim()] = values[index] || '';
                });
                mappings.push(row);
            }

            validatedMappings = new Array(mappings.length).fill(null);
            currentIndex = 0;
            showMapping(currentIndex);
            document.getElementById('validationCard').classList.remove('hidden');
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function showMapping(index) {
            const mapping = mappings[index];
            
            document.getElementById('propDisplay').textContent = 
                `Proprietary ${mapping.prop_code} - ${mapping.prop_display}`;
            
            // Parse context to extract type and value info
            const context = mapping.context;
            
            if (context.includes('numerical')) {
                const avgMatch = context.match(/Average: ([\d.]+)/);
                const avg = avgMatch ? avgMatch[1] : '';
                document.getElementById('typeBadge').textContent = 'Numerical';
                document.getElementById('propContext').textContent = `Average: ${avg}`;
            } else if (context.includes('categorical')) {
                const catMatch = context.match(/Categories: (.+)/);
                const categories = catMatch ? catMatch[1] : '';
                document.getElementById('typeBadge').textContent = 'Categorical';
                document.getElementById('propContext').textContent = `Categories: ${categories}`;
            }

            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';

            for (let i = 1; i <= 3; i++) {
                const system = mapping[`option_${i}_system`];
                const code = mapping[`option_${i}_code`];
                
                if (!system || !code) continue;

                const option = document.createElement('div');
                option.className = 'option';
                option.dataset.optionNum = i;
                
                if (validatedMappings[index] === i) {
                    option.classList.add('selected');
                }

                const rank = mapping[`option_${i}_rank`];
                const rankBadge = rank && rank !== '-1' ? 
                    `<span class="option-rank">Frequency Rank: ${rank}</span>` : 
                    `<span class="option-rank unavailable">Frequency Rank Unavailable</span>`;

                option.innerHTML = `
                    <div class="option-header">
                        <span class="option-title">Option ${i}: ${system} ${code} - ${mapping[`option_${i}_display`]}</span>
                        ${rankBadge}
                    </div>
                    <div class="option-reasoning">${mapping[`option_${i}_reasoning`]}</div>
                `;

                option.onclick = () => selectOption(i);
                container.appendChild(option);
            }

            updateProgress();
            updateButtons();
        }

        function selectOption(optionNum) {
            validatedMappings[currentIndex] = optionNum;
            
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`[data-option-num="${optionNum}"]`).classList.add('selected');
            
            document.getElementById('nextBtn').disabled = false;
        }

        function nextMapping() {
            if (currentIndex < mappings.length - 1) {
                currentIndex++;
                showMapping(currentIndex);
            } else {
                showComplete();
            }
        }

        function prevMapping() {
            if (currentIndex > 0) {
                currentIndex--;
                showMapping(currentIndex);
            }
        }

        function updateProgress() {
            const validated = validatedMappings.filter(v => v !== null).length;
            const total = mappings.length;
            const percent = (validated / total) * 100;
            
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = 
                `${validated} of ${total} validated (${currentIndex + 1} of ${total})`;
        }

        function updateButtons() {
            document.getElementById('prevBtn').disabled = currentIndex === 0;
            document.getElementById('nextBtn').disabled = validatedMappings[currentIndex] === null;
            
            if (currentIndex === mappings.length - 1 && validatedMappings[currentIndex] !== null) {
                document.getElementById('nextBtn').textContent = 'Complete';
            } else {
                document.getElementById('nextBtn').textContent = 'Next';
            }
        }

        function showComplete() {
            document.getElementById('validationCard').classList.add('hidden');
            document.getElementById('completeCard').classList.remove('hidden');
            
            // Update progress to 100%
            const total = mappings.length;
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('progressText').textContent = 
                `${total} of ${total} validated`;
        }

        function downloadCSV() {
            const headers = ['prop_code', 'prop_display', 'context', 
                           'validated_system', 'validated_code', 'validated_display', 
                           'validated_rank', 'validated_reasoning'];
            
            let csv = headers.join(',') + '\n';
            
            mappings.forEach((mapping, index) => {
                const selectedOption = validatedMappings[index];
                const row = [
                    mapping.prop_code,
                    `"${mapping.prop_display}"`,
                    `"${mapping.context}"`,
                    mapping[`option_${selectedOption}_system`],
                    mapping[`option_${selectedOption}_code`],
                    `"${mapping[`option_${selectedOption}_display`]}"`,
                    mapping[`option_${selectedOption}_rank`],
                    `"${mapping[`option_${selectedOption}_reasoning`]}"`
                ];
                csv += row.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'validated_mappings.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
